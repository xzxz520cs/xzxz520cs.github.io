<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆç‹æ¦‚ç‡è®¡ç®—å™¨ - å¤©å¤©å‘è›‹ç³•çš„å·¥å…·ç®±</title>
    <meta name="description" content="æ¸¸æˆç‹æ¦‚ç‡è®¡ç®—å™¨ - ä¸“ä¸šçš„å¡ç»„æ¦‚ç‡åˆ†æå·¥å…·ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¡ä»¶åˆ¤æ–­ï¼Œç²¾ç¡®è®¡ç®—å¯åŠ¨ç‡å’Œä¸Šæ‰‹ç‡ç­‰æ¦‚ç‡ã€‚å¸®æ‚¨ä¼˜åŒ–å¡ç»„æ„ç­‘ã€‚">
    <meta name="keywords" content="æ¸¸æˆç‹, æ¦‚ç‡è®¡ç®—, å¡ç»„å·¥å…·">
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <link rel="stylesheet" href="../../assets/css/yu-gi-oh-probability-calculator.css">
</head>

<body>
    <!-- æ–°å¢ï¼šæ¨¡æ¿é¡µå¤´ -->
    <header class="site-header">
        <div class="container">
            <div class="site-title">
                <a href="/" style="color: inherit; text-decoration: none;">
                    <span class="site-title">å¤©å¤©å‘è›‹ç³•çš„å·¥å…·ç®±</span>
                </a>
            </div>
            <label for="menu-toggle-checkbox" class="menu-toggle" aria-label="æ‰“å¼€èœå•">â˜°</label>
            <nav class="nav-menu">
                <ul class="nav-list">
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" aria-haspopup="true" aria-expanded="false">å·¥å…·</a>
                        <ul class="dropdown-menu">
                            <li><a href="/tools/yu-gi-oh-probability-calculator/" class="dropdown-item">æ¸¸æˆç‹æ¦‚ç‡è®¡ç®—å™¨</a>
                            </li>
                            <li><a href="/tools/webp-avif-2-jpg-png/" class="dropdown-item">AVIF/WebPè½¬JPG/PNG</a></li>
                            <li><a href="https://chromewebstore.google.com/detail/kmnmkpgmneeokldcmfcgjppgpcfecoed"
                                    class="dropdown-item">æ¢å¤å…³é—­çš„æ ‡ç­¾é¡µ</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <input type="checkbox" id="menu-toggle-checkbox" hidden>
        <div class="drawer">
            <div class="container">
                <label for="menu-toggle-checkbox" class="menu-toggle close-menu" aria-label="å…³é—­èœå•">Ã—</label>
            </div>
            <nav class="drawer-menu">
                <ul class="drawer-list">
                    <li class="drawer-item">
                        <a href="#" class="drawer-link">å·¥å…·</a>
                        <ul class="drawer-submenu">
                            <li><a href="/tools/yu-gi-oh-probability-calculator/" class="drawer-subitem">æ¸¸æˆç‹æ¦‚ç‡è®¡ç®—å™¨</a>
                            </li>
                            <li><a href="/tools/webp-avif-2-jpg-png/" class="drawer-subitem">AVIF/WebPè½¬JPG/PNG</a></li>
                            <li><a href="https://chromewebstore.google.com/detail/kmnmkpgmneeokldcmfcgjppgpcfecoed"
                                    class="drawer-subitem">æ¢å¤å…³é—­çš„æ ‡ç­¾é¡µ</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <label for="menu-toggle-checkbox" class="drawer-overlay"></label>
    </header>

    <main class="container">
        <h1>æ¸¸æˆç‹æ¦‚ç‡è®¡ç®—å™¨</h1>

        <div class="card card--elevated">
            <!-- å¡ç»„ç®¡ç† -->
            <div class="deck-management mb-1">
                <div class="form-group">
                    <label for="deckList">é€‰æ‹©å¡ç»„</label>
                    <select id="deckList" class="form-control">
                        <option value="">-- é€‰æ‹©å¡ç»„ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deckName">å¡ç»„åç§°</label>
                    <input type="text" id="deckName" class="form-control" placeholder="è¾“å…¥å¡ç»„åç§°">
                </div>
                <div class="form-group deck-actions">
                    <button onclick="saveDeck()" class="btn btn--success">ä¿å­˜</button>
                    <button onclick="loadDeck()" class="btn btn--secondary">åŠ è½½</button>
                    <button onclick="deleteDeck()" class="btn btn--danger">åˆ é™¤</button>
                </div>
            </div>

            <div class="main-content">
                <!-- å¡ç‰Œè¾“å…¥ -->
                <div class="card-input-section">
                    <h2 class="mt-1 mb-2">å¡ç‰Œè¾“å…¥</h2>
                    <div id="cardInputs" class="card-input-grid"></div>
                </div>

                <!-- å³ä¾§åŒºåŸŸ -->
                <div class="right-section">
                    <!-- é¥¼å›¾å®¹å™¨ -->
                    <div class="chart-section">
                        <h2 class="mt-1 mb-2">å¡ç»„æ„æˆ</h2>
                        <canvas id="deckPieChart"></canvas>
                    </div>

                    <!-- æŠ½å¡è®¾ç½® -->
                    <div class="draw-settings">
                        <h2 class="mt-1 mb-2">æŠ½å¡è®¾ç½®</h2>
                        <div class="draw-inputs">
                            <div class="form-group">
                                <label for="total">å¡ç»„æ€»æ•°</label>
                                <input type="number" id="total" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="draws">æŠ½å¡æ•°</label>
                                <input type="number" id="draws" class="form-control" value="5" min="1" max="60">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é€»è¾‘åˆ¤æ–­æ¡ä»¶ -->
            <div class="condition-section">
                <div>
                    <h2 class="mt-1 mb-2">é€»è¾‘åˆ¤æ–­æ¡ä»¶</h2>
                    <!-- æ–°å¢ï¼šå•é€‰æŒ‰é’®ç»„ -->
                    <div class="condition-mode">
                        <label>
                            <input type="radio" name="conditionInputMode" value="manual" checked>
                            æ‰‹åŠ¨è¾“å…¥
                        </label>
                        <label>
                            <input type="radio" name="conditionInputMode" value="builder">
                            æ¡ä»¶æ„å»ºå™¨è¾“å…¥
                        </label>
                    </div>
                </div>
                <div class="form-group" id="manualConditionInput">
                    <textarea id="condition" class="form-control" rows="3" placeholder="è¾“å…¥é€»è¾‘åˆ¤æ–­æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š
a >= 1  // è‡³å°‘æŠ½åˆ°1å¼ Aç±»å¡
                        
(a >= 1 || b >= 1) && c == 0  // æŠ½åˆ°Aæˆ–Bç±»å¡ä¸”æ²¡æœ‰Cç±»å¡
                        
a + b >= 3  // Aå’ŒBç±»å¡åˆè®¡è‡³å°‘3å¼ 
                        
ç°æµä¸½ >= 1 && å¢æ®–çš„G >= 1 && æŠ¹æ€ä¹‹æŒ‡åè€… == 0  // ä½¿ç”¨è‡ªå®šçš„å¡åæ¥å†™è¡¨è¾¾å¼"></textarea>
                </div>
                <!-- æ–°å¢ï¼šæ¡ä»¶æ„å»ºå™¨åŒºåŸŸ -->
                <div id="builderConditionInput" class="form-group hidden">
                    <div id="conditionBuilder"></div>
                    <!-- æ–°å¢ï¼šå®æ—¶æ˜¾ç¤ºæ„å»ºå™¨ç”Ÿæˆçš„æ¡ä»¶è¡¨è¾¾å¼ -->
                    <label class="mt-1 mb-1" for="builderConditionPreview"><strong>ç”Ÿæˆçš„é€»è¾‘åˆ¤æ–­æ¡ä»¶ï¼š</strong></label>
                    <textarea id="builderConditionPreview" class="form-control" rows="2" readonly></textarea>
                </div>
                <div class="operator-help">
                    <strong>è¾“å…¥è¯´æ˜ï¼š</strong><br>
                    <strong>è¿ç®—ç¬¦ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰:</strong><code>()</code> - æ˜ç¡®è¿ç®—ä¼˜å…ˆçº§ï¼›<code>!</code> - é€»è¾‘éï¼›<code>*</code> -
                    ä¹˜ï¼›<code>/</code> - é™¤ï¼›<code>%</code> - å–æ¨¡ï¼›<code>+</code> - åŠ ï¼›<code>-</code> -
                    å‡ï¼›<strong>æ¯”è¾ƒè¿ç®—ç¬¦ï¼š</strong><code>&gt;</code> - å¤§äºï¼›<code>&gt;=</code> - å¤§äºç­‰äºï¼›<code>&lt;</code> -
                    å°äºï¼›<code>&lt;=</code> - å°äºç­‰äºï¼›<code>==</code> - ç­‰äºï¼›<code>!=</code> - ä¸ç­‰ï¼›<code>&&</code> -
                    é€»è¾‘ä¸ï¼›<code>||</code> - é€»è¾‘æˆ–ï¼›<br>
                    <strong>å˜é‡å:</strong><code>a</code>,<code>b</code>,<code>c</code>,...,<code>z</code>,<code>aa</code>,<code>ab</code>,...å¯¹åº”
                    Aç±»å¡, Bç±»å¡, ...,
                    Zç±»å¡, AAç±»å¡, ABç±»å¡, ...ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ‚¨è¾“å…¥çš„è‡ªå®šå¡åã€‚<br>
                    <strong>ä½¿ç”¨æç¤ºï¼š</strong>è®¡ç®—å™¨ä¼šå¸®æ‚¨å°†è‡ªå®šå¡åæ›¿æ¢ä¸ºå¯¹åº”çš„å˜é‡åï¼Œæ‰€ä»¥è‡ªå®šå¡åå»ºè®®é¿å…ä½¿ç”¨å®¹æ˜“ä¸é€»è¾‘åˆ¤æ–­æ¡ä»¶æ··æ·†çš„åç§°(å¦‚a>1)ã€‚å»ºè®®ä½¿ç”¨çº¯ä¸­æ–‡åã€‚<br>
                    <strong>æ³¨æ„ï¼š</strong>åœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ï¼Œ<code>=</code>æ˜¯èµ‹å€¼è¿ç®—ç¬¦ã€‚å¦‚æœæ‚¨è¦åˆ¤æ–­ç›¸ç­‰ï¼Œè¯·ä½¿ç”¨<code>==</code>æˆ–<code>===</code>ã€‚æ³¨æ„ä¸è¦ä½¿ç”¨ä¸­æ–‡æ ‡ç‚¹ç¬¦å·æ¥ä¹¦å†™è¿ç®—ç¬¦ï¼ˆä¾‹å¦‚ä¸­æ–‡æ‹¬å·ï¼‰ã€‚
                    <br>
                </div>
            </div>

            <!-- è®¡ç®—æŒ‰é’® -->
            <div class="calculation-actions mt-2 mb-2">
                <button onclick="calculate()" class="btn btn--primary">å¼€å§‹è®¡ç®—</button>
                <button onclick="cancelCalculation()" id="cancelBtn" class="btn btn--danger hidden">å–æ¶ˆè®¡ç®—</button>
            </div>
            <div class="calculation-actions mt-2 mb-2">
                <button onclick="exportCalculationRecords()" class="btn btn--outline">å¯¼å‡ºè®°å½•</button>
                <button onclick="clearCalculationRecords()" class="btn btn--danger">åˆ é™¤è®°å½•</button>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div id="progressContainer" class="progress-container hidden">
                <div class="form-group">
                    <label>è®¡ç®—è¿›åº¦</label>
                    <progress id="calculationProgress" value="0" max="100"></progress>
                    <div id="progressText" class="text-center">ç­‰å¾…è®¡ç®—...</div>
                </div>
            </div>

            <!-- ç»“æœè¾“å‡º -->
            <div class="result-section">
                <h2 class="mt-1 mb-2">è®¡ç®—ç»“æœ</h2>
                <div class="result-grid grid">
                    <div class="form-group">
                        <label for="probability">æ¦‚ç‡</label>
                        <input type="text" id="probability" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="validCombinations">æ»¡è¶³æ¡ä»¶çš„ç»„åˆæ•°</label>
                        <input type="text" id="validCombinations" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="totalCombinations">æ€»ç»„åˆæ•°</label>
                        <input type="text" id="totalCombinations" class="form-control" readonly>
                    </div>
                </div>
            </div>

            <div class="source-info">
                <p class="mb-1 mt-6">
                    è¯¥å·¥å…·éƒ¨åˆ†ä»£ç ä¸æ€è·¯æ¥æºäº<a href="https://tieba.baidu.com/home/main?id=tb.1.700dbce0.kfzKa-FBDB-cm-gMSey3Yw"
                        target="_blank">@jyhyqw</a>åœ¨è´´å§<a href="https://tieba.baidu.com/p/5516965391"
                        target="_blank">ä¸Šä½å¡ç»„å§å‘å¸–</a>å‘å¸ƒçš„<a href="æ¦‚ç‡è®¡ç®—å™¨æ”¹.zip" target="_blank">æ¸¸æˆç‹æ¦‚ç‡è®¡ç®—å™¨</a>ã€‚
                </p>
            </div>
        </div>
    </main>

    <!-- æ–°å¢ï¼šæ¨¡æ¿é¡µè„š -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div>
                    <h3 class="footer-title">å…³äºä½œè€…</h3>
                    <ul class="footer-links">
                        <li><a href="mailto:ttfdg520cs@gmail.com">ttfdg520cs@gmail.com</a></li>
                        <li><a href="https://space.bilibili.com/1446349" target="_blank">Bilibiliä¸»é¡µ</a></li>
                        <li><a href="https://github.com/xzxz520cs" target="_blank">GitHub</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="text-muted">Â© 2025 å¤©å¤©å‘è›‹ç³•çš„å·¥å…·ç®±</p>
            </div>
        </div>
    </footer>

    <script async src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="../../assets/js/yu-gi-oh-probability-calculator.js"></script>
    <!-- æ–°å¢ï¼šæ¡ä»¶æ„å»ºå™¨è„šæœ¬ -->
    <script>
        // --- æ¡ä»¶æ„å»ºå™¨æ ¸å¿ƒé€»è¾‘ ---
        // å˜é‡åè‡ªåŠ¨è·å–
        function getAllCardNames() {
            // å…ˆç”Ÿæˆå˜é‡å a,b,c,...,z,aa,ab,ac...æœ€å¤š30ä¸ª
            const varNames = [];
            for (let i = 0; i < 30; i++) {
                if (i < 26) {
                    varNames.push(String.fromCharCode(97 + i));
                } else {
                    varNames.push('a' + String.fromCharCode(97 + i - 26));
                }
            }
            // ç”¨æˆ·è‡ªå®šä¹‰å¡å
            const customNames = [];
            for (let i = 0; i < 30; i++) {
                const name = document.getElementById(`cardName${i}`)?.value.trim();
                if (name && !varNames.includes(name) && !customNames.includes(name)) customNames.push(name);
            }
            // è¿”å›å˜é‡å+è‡ªå®šä¹‰å¡å
            return [...varNames, ...customNames];
        }
        // è¿ç®—ç¬¦æ˜ å°„
        const builderOperators = {
            gt: '>', eq: '==', lt: '<', neq: '!=', gte: '>=', lte: '<='
        };
        // æ„å»ºå™¨æ ¹èŠ‚ç‚¹
        let builderRootCondition = null;
        // æ„å»ºå™¨æ¨¡å¼ä¸‹çš„æ¡ä»¶è¡¨è¾¾å¼ç¼“å­˜
        let builderConditionText = '';
        // æ„å»ºå™¨åˆå§‹åŒ–
        function builderCreateCondition(type, children) {
            return type === 'single' ? {
                type: 'single',
                cards: [{ name: getAllCardNames()[0] }],
                symbol: 'gt',
                num: '0'
            } : { type, children: children || [] };
        }
        function builderRender() {
            const builder = document.getElementById('conditionBuilder');
            builder.innerHTML = '';
            builderRootCondition && builder.appendChild(builderRenderCondition(builderRootCondition, true));
            builderUpdateOutput();
        }
        function builderRenderCondition(condition, isRoot = false) {
            const container = document.createElement('div');
            container.className = `condition-builder condition-${condition.type}`;
            if (condition.type === 'single') {
                builderRenderSingleCondition(condition, container, isRoot);
            } else {
                builderRenderGroupCondition(condition, container, isRoot);
            }
            return container;
        }
        function builderRenderSingleCondition(condition, container, isRoot) {
            container.appendChild(document.createTextNode('æŠ½åˆ°'));
            // ä¿®æ”¹ï¼šä¸ºcardsWrapperæ·»åŠ ç±»
            const cardsWrapper = document.createElement('div');
            cardsWrapper.className = 'builder-cards-wrapper';
            condition.cards.forEach((card, index) => {
                const cardRow = document.createElement('div');
                cardRow.className = 'builder-card-row';
                if (index > 0) {
                    const opSelect = builderCreateSelect(['+', '-', '*', '/'], card.operator || '+',
                        e => { card.operator = e.target.value; builderUpdateOutput(); });
                    cardRow.appendChild(opSelect);
                }
                // å¡åé€‰æ‹©/è‡ªå®šä¹‰åˆ‡æ¢
                const cardNameContainer = document.createElement('span');
                let cardNameControl = builderCreateSelect(
                    getAllCardNames().map(name => ({ display: name, value: name })),
                    card.name,
                    e => { card.name = e.target.value; builderUpdateOutput(); }
                );
                cardNameContainer.appendChild(cardNameControl);
                const toggleButton = builderCreateButton('âœï¸', () => {
                    if (cardNameControl.tagName.toLowerCase() === 'select') {
                        // åˆ‡æ¢ä¸ºè‡ªå®šä¹‰è¾“å…¥
                        const customInput = builderCreateInput(card.name, e => { card.name = e.target.value; builderUpdateOutput(); });
                        customInput.classList.add('builder-card-input');
                        cardNameContainer.replaceChild(customInput, cardNameControl);
                        cardNameControl = customInput;
                        toggleButton.textContent = 'ğŸ“‘';
                    } else {
                        // åˆ‡æ¢ä¸ºä¸‹æ‹‰é€‰æ‹©æ¡†
                        const newSelect = builderCreateSelect(
                            getAllCardNames().map(name => ({ display: name, value: name })),
                            card.name,
                            e => { card.name = e.target.value; builderUpdateOutput(); }
                        );
                        cardNameContainer.replaceChild(newSelect, cardNameControl);
                        cardNameControl = newSelect;
                        toggleButton.textContent = 'âœï¸';
                    }
                });
                cardRow.appendChild(cardNameContainer);
                cardRow.appendChild(toggleButton);
                if (condition.cards.length > 1) {
                    cardRow.appendChild(builderCreateButton('Ã—', () => {
                        condition.cards.splice(index, 1);
                        builderRender();
                    }));
                }
                cardsWrapper.appendChild(cardRow);
            });
            container.appendChild(cardsWrapper);
            container.appendChild(builderCreateButton('+', () => {
                condition.cards.push({ name: getAllCardNames()[0], operator: '+' });
                builderRender();
            }));
            container.appendChild(document.createTextNode('çš„æ•°é‡'));
            const symbolSelect = builderCreateSelect(
                Object.entries(builderOperators).map(([value, display]) => ({ display, value })),
                condition.symbol,
                e => { condition.symbol = e.target.value; builderUpdateOutput(); }
            );
            container.appendChild(symbolSelect);
            container.appendChild(builderCreateInput(condition.num, e => { condition.num = e.target.value; builderUpdateOutput(); }, '40px'));
            !isRoot && container.appendChild(builderCreateButton('åˆ é™¤', () => {
                container.dispatchEvent(new CustomEvent('delete', { bubbles: true }));
            }));
        }
        function builderRenderGroupCondition(condition, container, isRoot) {
            const header = document.createElement('div');
            header.className = 'builder-group-header';
            header.appendChild(document.createTextNode('æ»¡è¶³ä»¥ä¸‹'));
            header.appendChild(builderCreateSelect(
                ['å…¨éƒ¨', 'ä»»ä¸€'].map((text, i) => ({ display: text, value: i === 0 ? 'and' : 'or' })),
                condition.type,
                e => { condition.type = e.target.value; builderUpdateOutput(); }
            ));
            header.appendChild(document.createTextNode('æ¡ä»¶'));
            !isRoot && header.appendChild(builderCreateButton('åˆ é™¤', () => {
                container.dispatchEvent(new CustomEvent('delete', { bubbles: true }));
            }));
            container.appendChild(header);
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'builder-group-children';
            condition.children.forEach(child => {
                const childElement = builderRenderCondition(child);
                childElement.addEventListener('delete', e => {
                    e.stopPropagation();
                    const index = condition.children.indexOf(child);
                    index !== -1 && condition.children.splice(index, 1) && builderRender();
                });
                childrenContainer.appendChild(childElement);
            });
            const buttons = document.createElement('div');
            buttons.className = 'builder-buttons';
            buttons.appendChild(builderCreateButton('æ·»åŠ æ¡ä»¶ç»„', () => {
                condition.children.push(builderCreateCondition('and', []));
                builderRender();
            }));
            buttons.appendChild(builderCreateButton('æ·»åŠ æ¡ä»¶', () => {
                condition.children.push(builderCreateCondition('single'));
                builderRender();
            }));
            childrenContainer.appendChild(buttons);
            container.appendChild(childrenContainer);
        }
        function builderUpdateOutput() {
            builderConditionText = builderRootCondition ? builderGenerateConditionText(builderRootCondition) : '';
            // åŒæ­¥åˆ°éšè—çš„textareaï¼ˆç”¨äºä¿å­˜/è®¡ç®—ï¼‰
            document.getElementById('condition').value = builderConditionText;
            // æ–°å¢ï¼šå®æ—¶æ˜¾ç¤ºåˆ°é¢„è§ˆåŒºåŸŸ
            const preview = document.getElementById('builderConditionPreview');
            if (preview) preview.value = builderConditionText;
        }
        function builderGenerateConditionText(condition) {
            if (condition.type === 'single') {
                const cardsText = condition.cards.map((c, i) =>
                    i === 0 ? c.name : `${c.operator || '+'} ${c.name}`).join(' ');
                return `(${cardsText}) ${builderOperators[condition.symbol]} ${condition.num}`;
            }
            const childrenText = condition.children.map(builderGenerateConditionText).filter(Boolean);
            return childrenText.length > 1
                ? `(${childrenText.join(condition.type === 'and' ? ' && ' : ' || ')})`
                : childrenText[0] || '';
        }
        function builderCreateSelect(options, value, onChange) {
            const select = document.createElement('select');
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value || opt;
                option.textContent = opt.display || opt;
                select.appendChild(option);
            });
            select.value = value;
            select.addEventListener('change', onChange);
            return select;
        }
        function builderCreateInput(value, onChange, width) {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = value;
            input.setAttribute('list', 'cardNamesDatalist');
            input.addEventListener('input', onChange);
            return input;
        }
        function builderCreateButton(text, onClick) {
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = text;
            let variant = 'btn--outline';
            if (text.trim() === 'Ã—' || text.trim() === 'åˆ é™¤') {
                variant = 'btn--danger';
            }
            button.className = `btn ${variant}`;
            // æ–°å¢ï¼šå¯¹äºâ€œæ·»åŠ æ¡ä»¶ç»„â€å’Œâ€œæ·»åŠ æ¡ä»¶â€æŒ‰é’®ï¼Œå–æ¶ˆå›ºå®šå®½åº¦è®¾ç½®
            if (text.trim() === 'æ·»åŠ æ¡ä»¶ç»„' || text.trim() === 'æ·»åŠ æ¡ä»¶') {
                button.className += ' btn--auto-width';
            }
            button.addEventListener('click', onClick);
            return button;
        }
        // ä»¤ç‰ŒåŒ–å‡½æ•°ï¼šå°†è¾“å…¥æ‹†åˆ†ä¸ºæ ‡è¯†ç¬¦ã€æ•°å­—ã€è¿ç®—ç¬¦å’Œæ‹¬å·
        function tokenize(expr) {
            const tokens = [];
            const regex = /\s*([A-Za-z0-9\u4e00-\u9fa5]+|>=|<=|==|!=|&&|\|\||[()+><])\s*/g;
            let m;
            while ((m = regex.exec(expr)) !== null) {
                tokens.push(m[1]);
            }
            return tokens;
        }

        // è§£æå™¨çŠ¶æ€
        function Parser(tokens) {
            this.tokens = tokens;
            this.pos = 0;
        }
        Parser.prototype.peek = function () {
            return this.tokens[this.pos];
        };
        Parser.prototype.consume = function (token) {
            if (token && this.tokens[this.pos] !== token) {
                throw new Error("é¢„æœŸ " + token + "ï¼Œä½†å¾—åˆ° " + this.tokens[this.pos]);
            }
            return this.tokens[this.pos++];
        };
        Parser.prototype.eof = function () {
            return this.pos >= this.tokens.length;
        };

        // è§£æå…¥å£ï¼šè§£æå®Œæ•´è¡¨è¾¾å¼ï¼ˆæ”¯æŒé€»è¾‘ && å’Œ ||ï¼‰
        function parseExpression(parser) {
            return parseLogicalOr(parser);
        }
        function parseLogicalOr(parser) {
            let node = parseLogicalAnd(parser);
            while (!parser.eof() && parser.peek() === '||') {
                parser.consume('||');
                const right = parseLogicalAnd(parser);
                node = { type: "or", children: [node, right] };
            }
            return node;
        }
        function parseLogicalAnd(parser) {
            let node = parseRelational(parser);
            while (!parser.eof() && parser.peek() === '&&') {
                parser.consume('&&');
                const right = parseRelational(parser);
                node = { type: "and", children: [node, right] };
            }
            return node;
        }

        // è§£æå…³ç³»è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ sumExpression > 0
        function parseRelational(parser) {
            let left = parseSum(parser);
            if (!parser.eof() && /^(>=|<=|==|!=|>|<)$/.test(parser.peek())) {
                const op = parser.consume();
                const num = parser.consume();
                if (!/^\d+$/.test(num)) {
                    throw new Error("é¢„æœŸæ•°å­—ï¼Œä½†å¾—åˆ° " + num);
                }
                // æ„é€ å•ä¸€æ¡ä»¶èŠ‚ç‚¹ï¼šæ‹†åˆ†åŠ æ³•è¡¨è¾¾å¼
                let cards = [];
                if (Array.isArray(left)) {
                    // leftä¸ºæ ‡è¯†ç¬¦æ•°ç»„
                    cards.push({ name: left[0] });
                    left.slice(1).forEach(item => {
                        cards.push({ operator: "+", name: item });
                    });
                } else {
                    cards.push({ name: left });
                }
                return { type: "single", cards: cards, symbol: mapOperator(op), num: num };
            }
            return left;
        }

        // è§£æåŠ æ³•è¡¨è¾¾å¼æˆ–è€…åŸå­è¡¨è¾¾å¼
        // å¦‚æœé‡åˆ°æ‹¬å·åˆ™è°ƒç”¨ parseExpressionï¼Œå¦åˆ™è¿”å›æ ‡è¯†ç¬¦ï¼ˆæˆ–æ‹†åˆ†åŠ æ³•ï¼‰
        function parseSum(parser) {
            if (parser.peek() === '(') {
                parser.consume('(');
                const node = parseExpression(parser);
                parser.consume(')');
                return node;
            }
            // è§£æä¸€ä¸²æ ‡è¯†ç¬¦ç”¨ '+' è¿æ¥ï¼Œåœ¨æ­¤ç®€å•åªæ”¯æŒåŠ æ³•
            let items = [];
            items.push(parser.consume());
            while (!parser.eof() && parser.peek() === '+') {
                parser.consume('+');
                items.push(parser.consume());
            }
            // è‹¥ä»…æœ‰ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œåˆ™è¿”å›å•ä¸ªå€¼ï¼Œå¦åˆ™è¿”å›æ•°ç»„
            return items.length === 1 ? items[0] : items;
        }

        // è¿ç®—ç¬¦æ˜ å°„
        function mapOperator(op) {
            const opMap = { ">": "gt", "<": "lt", "==": "eq", "!=": "neq", ">=": "gte", "<=": "lte" };
            if (!opMap[op]) throw new Error("ä¸æ”¯æŒçš„è¿ç®—ç¬¦ï¼š" + op);
            return opMap[op];
        }

        // ä¸»è§£æå‡½æ•°ã€‚è¿”å›æ„å»ºå™¨æ¡ä»¶æ•°æ®
        function parseManualCondition(manualStr) {
            manualStr = manualStr.trim();
            if (!manualStr) throw new Error("ç©ºçš„æ¡ä»¶");
            const tokens = tokenize(manualStr);
            const parser = new Parser(tokens);
            const tree = parseExpression(parser);
            if (!parser.eof()) {
                throw new Error("æ— æ³•è§£ææ¡ä»¶ï¼š" + manualStr);
            }
            return tree;
        }

        // ä¿®æ”¹ï¼šåˆ‡æ¢è¾“å…¥æ–¹å¼é€»è¾‘ï¼Œæ”¯æŒæ‰‹åŠ¨æ¡ä»¶ä¸æ„å»ºå™¨æ¡ä»¶çš„äº’è½¬
        function switchConditionInputMode(mode) {
            const manualDiv = document.getElementById('manualConditionInput');
            const builderDiv = document.getElementById('builderConditionInput');
            if (mode === 'manual') {
                // ä»æ„å»ºå™¨è½¬æ¢ä¸ºæ‰‹åŠ¨
                if (builderRootCondition) {
                    document.getElementById('condition').value = builderGenerateConditionText(builderRootCondition);
                }
                builderDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');
            } else {
                // ä»æ‰‹åŠ¨è½¬æ¢ä¸ºæ„å»ºå™¨ï¼Œå°è¯•è½¬æ¢æ‰‹åŠ¨è¾“å…¥çš„æ¡ä»¶
                let manualStr = document.getElementById('condition').value.trim();
                if (manualStr) {
                    try {
                        builderRootCondition = parseManualCondition(manualStr);
                        builderRender();
                    } catch (err) {
                        alert("æ‰‹åŠ¨æ¡ä»¶è½¬æ¢å¤±è´¥ï¼š" + err.message);
                        document.querySelector('input[name="conditionInputMode"][value="manual"]').checked = true;
                        return;
                    }
                }
                manualDiv.classList.add('hidden');
                builderDiv.classList.remove('hidden');
            }
        }
        // ä¿®æ”¹ï¼šç›‘å¬è¾“å…¥æ–¹å¼åˆ‡æ¢æ—¶ç§»é™¤é˜»æ­¢æ¨¡å¼åˆ‡æ¢çš„åˆ¤æ–­
        document.querySelectorAll('input[name="conditionInputMode"]').forEach(radio => {
            radio.addEventListener('change', function (e) {
                const mode = e.target.value;
                // ç§»é™¤é˜»æ­¢åˆ‡æ¢çš„åˆ¤æ–­ï¼Œç¡®ä¿æ¯æ¬¡åˆ‡æ¢éƒ½èƒ½æ‰§è¡Œ
                switchConditionInputMode(mode);
                lastBuilderMode = mode;
            });
        });
        // ç›‘å¬è¾“å…¥æ–¹å¼åˆ‡æ¢
        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹åŒ–æ„å»ºå™¨
            builderRootCondition = builderCreateCondition('and', []);
            builderRender();
            // åˆå§‹åŒ–æ˜¾ç¤º
            switchConditionInputMode('manual');
            // æ–°å¢ï¼šç›‘å¬å¡ç‰Œè¾“å…¥å˜åŠ¨
            setupCardNameInputListener();
        });
        // ä¿å­˜/åŠ è½½æ”¯æŒ
        window.getConditionInputMode = function () {
            return document.querySelector('input[name="conditionInputMode"]:checked')?.value || 'manual';
        };
        window.getBuilderConditionData = function () {
            return builderRootCondition ? JSON.stringify(builderRootCondition) : '';
        };
        window.setBuilderConditionData = function (json) {
            try {
                builderRootCondition = JSON.parse(json);
                builderRender();
            } catch (e) {
                builderRootCondition = builderCreateCondition('and', []);
                builderRender();
            }
        };
        // ç›‘å¬å¡ç‰Œè¾“å…¥å˜åŠ¨ï¼Œå®æ—¶åˆ·æ–°æ¡ä»¶æ„å»ºå™¨ä¸‹æ‹‰é€‰å•
        function setupCardNameInputListener() {
            const cardInputs = document.getElementById('cardInputs');
            if (!cardInputs) return;
            // äº‹ä»¶å§”æ‰˜ï¼Œç›‘å¬æ‰€æœ‰input
            cardInputs.addEventListener('input', function (e) {
                if (e.target && e.target.id && e.target.id.startsWith('cardName')) {
                    // é‡æ–°æ¸²æŸ“æ¡ä»¶æ„å»ºå™¨
                    if (document.querySelector('input[name="conditionInputMode"]:checked')?.value === 'builder') {
                        builderRender();
                    }
                }
            });
            cardInputs.addEventListener('blur', function (e) {
                if (e.target && e.target.id && e.target.id.startsWith('cardName')) {
                    if (document.querySelector('input[name="conditionInputMode"]:checked')?.value === 'builder') {
                        builderRender();
                    }
                }
            }, true);
        }
    </script>
</body>

</html>