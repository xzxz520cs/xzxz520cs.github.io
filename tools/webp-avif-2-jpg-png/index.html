<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片格式转换工具 (AVIF/WebP → JPG/PNG)</title>
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>图片格式转换工具</h1>
        <p class="text-center text-muted">轻松将AVIF和WebP格式图片转换为JPG或PNG格式</p>
        
        <div class="card">
            <div class="upload-section flex flex--column">
                <div class="form-group">
                    <label for="formatSelect">输出格式</label>
                    <select id="formatSelect" class="btn btn--outline">
                        <option value="jpg">JPG</option>
                        <option value="png">PNG</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fileInput">选择图片文件</label>
                    <input type="file" id="fileInput" accept=".avif,.webp" multiple>
                    <p class="text-muted mt-2">支持格式：AVIF 和 WebP</p>
                </div>
                
                <div id="status" class="text-center">就绪</div>
                
                <div class="progress-bar mt-3 mb-3">
                    <div class="progress"></div>
                </div>
            </div>
        </div>
        
        <button id="downloadBtn" class="btn btn--primary btn--block hidden mt-4">下载全部图片</button>
        
        <div id="previewContainer" class="grid mt-5"></div>
    </div>

    <script>
        let convertedFiles = [];
        let totalFiles = 0;
        let processedCount = 0;

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('downloadBtn').addEventListener('click', downloadZip);

        async function handleFileSelect(e) {
            const files = e.target.files;
            if (!files.length) return;

            resetState();
            totalFiles = files.length;
            updateStatus(`正在处理 0/${totalFiles} 个文件...`);
            
            const format = document.getElementById('formatSelect').value;

            for (let file of files) {
                try {
                    const convertedData = await convertImage(file, format);
                    addPreview(convertedData, file.name);
                    convertedFiles.push(convertedData);
                } catch (error) {
                    console.error('转换失败:', error);
                    updateStatus(`文件 ${file.name} 转换失败: ${error.message}`);
                }
                updateProgress();
            }
        }

        async function convertImage(file, format) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const img = await loadImage(e.target.result);
                        const convertedBlob = await convertImageFormat(img, format);
                        resolve({
                            name: file.name.replace(/\.[^.]+$/, `.${format}`),
                            blob: convertedBlob
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = (e) => reject(new Error('图片加载失败'));
                img.src = src;
            });
        }

        function convertImageFormat(img, format) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
                canvas.toBlob(blob => resolve(blob), mimeType, format === 'jpg' ? 1 : undefined);
            });
        }

        function addPreview(data, originalName) {
            const preview = document.createElement('div');
            preview.className = 'card preview-card animate-fade';
            preview.innerHTML = `
                <img class="preview-img" src="${URL.createObjectURL(data.blob)}">
                <div class="file-name text-center mt-2">
                    <span class="text-muted">${originalName}</span> 
                    <span>→</span> 
                    <strong>${data.name}</strong>
                </div>
            `;
            document.getElementById('previewContainer').appendChild(preview);
        }

        function updateProgress() {
            processedCount++;
            const progress = (processedCount / totalFiles) * 100;
            document.querySelector('.progress').style.width = `${progress}%`;
            updateStatus(`正在处理 ${processedCount}/${totalFiles} 个文件...`);

            if (processedCount === totalFiles) {
                updateStatus('转换完成！');
                document.getElementById('downloadBtn').classList.remove('hidden');
            }
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function resetState() {
            convertedFiles = [];
            processedCount = 0;
            totalFiles = 0;
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('downloadBtn').classList.add('hidden');
            document.querySelector('.progress').style.width = '0%';
        }

        async function downloadZip() {
            const zip = new JSZip();
            const format = document.getElementById('formatSelect').value;
            const folder = zip.folder(`converted_${format}`);
            
            convertedFiles.forEach(file => {
                folder.file(file.name, file.blob);
            });

            const content = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `converted_images_${Date.now()}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
    
    <style>
        /* 补充样式 */
        .upload-section {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .progress-bar {
            height: 8px;
            background-color: var(--color-light);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            width: 0;
            background-color: var(--color-success);
            transition: width var(--transition-slow);
        }
        
        .preview-card {
            padding: var(--space-md);
            text-align: center;
            transition: transform var(--transition-fast);
        }
        
        .preview-card:hover {
            transform: translateY(-5px);
        }
        
        .preview-img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
            background: 
                linear-gradient(45deg, var(--color-medium) 25%, transparent 25%) -10px 0/ 20px 20px, 
                linear-gradient(-45deg, var(--color-medium) 25%, transparent 25%) -10px 0/ 20px 20px, 
                linear-gradient(45deg, transparent 75%, var(--color-medium) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--color-medium) 75%);
            background-color: var(--color-light);
        }
        
        .file-name {
            font-size: 0.9em;
            word-break: break-all;
        }
        
        #status {
            min-height: 1.5em;
            color: var(--color-secondary);
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .preview-card {
                padding: var(--space-sm);
            }
        }
    </style>
</body>
</html>
